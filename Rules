#!/usr/bin/env ruby

preprocess do
    tags.each do |tag|
        content = '<%= with_tag("'+tag+'").chronologic.reverse.enum %>'
        title = "Posts with tag '#{tag}'"
        identifier = "/tag/#{tag}/"
        @items << Nanoc::Item.new(content, {:title => title, :noindex => true}, identifier)
    end
    @items.each do |item|
        if item[:published]
            item[:published] = DateTime.parse(item[:published].to_s)
        end
    end
end

compile '/assets/style/' do
    filter :sass, syntax: :scss
end

compile '/feed/' do
    filter :erb
end

compile '*' do
    unless item.binary?
        filter :erb
        filter :kramdown
        layout 'default'
        if item[:title]
            filter :tidy
        end
    end
end

route '/assets/style/' do
    item.identifier.chop + '.css'
end

route '/articles/*/' do
    item.identifier[9..-1] + 'index.html'
end

route '*' do
    if item.binary?
        item.identifier.chop + '.' + item[:extension]
    elsif item[:published]
        "/"+item[:published].to_s.gsub("-","/")+item.identifier + 'index.html'
    else
        item.identifier + 'index.html'
    end
end

layout '*', :erb
